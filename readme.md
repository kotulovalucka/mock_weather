# Overview

### Purpose

This project is backend Weather API that gives users access to current and past weather data in article format generated by LLM. Users can customize how they see the forecast—choosing their language and the style of article they prefer.

### Key Features

- **Weather Forecast API**: Provides up-to-date and historical weather info in a readable article format.
- **Article Generation**: Uses a Large Language Model (LLM) to create weather articles. Users can choose between different article styles (factual or bulvar)
- **Language Options**: Supports both Slovak (SK) and English (EN), so users can read forecasts and articles in their preferred language. Any validation errors for requests are also displayed in the selected language.

### Technology Stack

- **Backend**: Deno 2.0 (TypeScript)
- **Database**: PostgreSQL 14.13
- **Containerization**: Docker 27.3.1
- **API Clients**:
  - `api.cohere.com`: For generating articles
  - `dataservice.accuweather.com`: For getting weather data
- **Worth to mention libraries**: Express, TypeORM, and Winston for logging

### Deployment

The app is hosted on AWS (EC2) and uses a CI/CD pipeline for automatic deployments. Check out the "Try it" section for examples on how to use the API.

# Try It

To test the API, here are two example `curl` commands for getting a current weather article and fetching a collection of historical weather data.

### 1. Get Current Weather Article

To get an up-to-date weather article for Bratislava, use the following `curl` command:

```bash
curl --location 'http://ec2-16-170-243-13.eu-north-1.compute.amazonaws.com:3000/api/v1/weather/article' \
--header 'Accept: */*' \
--header 'Accept-Language: sk' \
--header 'Content-Type: application/json' \
--data '{
    "location": "bratislava",
    "article": {
        "type": "bulvar"
    }
}'
```

### 2. Get Collection of Historical Weather Articles

To retrieve a collection of historical weather articles in English for Bratislava, try this command:

```bash
curl --location 'http://ec2-16-170-243-13.eu-north-1.compute.amazonaws.com:3000/api/v1/weather/article/collection?limit=10&offset=0&locationName=bratislava&articleType=factual' \
--header 'accept: application/json' \
--header 'content-type: application/json' \
--header 'Accept-Language: en'
```

# API Guide

## 1. Get Current Weather Article

- **Headers**:
  - `Accept-Language`: Choose `sk` for Slovak or `en` for English (English is the default if none is provided).
- **Request Body**:
  - `location` (string): Name of the town without dicaritics. For clarity, add the state after the town if needed, e.g., `"horna stubna slovakia"`.
  - `article.type` (string): Choose `"bulvar"` for a dramatic style or `"factual"` for a straightforward style.
- **Response Example**:
  ```json
  {
  	"message": {
  		"headline": "Chladnejší víkend v Hornej Stubne, soľte cesty!",
  		"perex": "Od soboty sa počasie v Hornej Stubne výrazne ochladí. Očakáva sa zníženie teplôt a možnosť dažďa, čo môže ovplyvniť plány na víkend.",
  		"description": "V Hornej Stubne sa v sobotu 2. novembra 2024 očakáva znatá zmenu počasia. Teploty počas dňa dosiahnu maximálne 12,2 °C, ale pocitová teplota bude len 15,2 °C. Noc bude chladná s minimálnou teplotou 5,5 °C a pocitovou teplotou 5,4 °C. Deň bude čiastočne slnečný s 25% pravdepodobnosťou dažďa. Očakáva sa 6 hodín slnečného svitu. Vítr bude vanúť rýchlosťou 5,6 km/h z juhovýchodu počas dňa a z severozápadu v noci. Oblačnosť bude dosť vysoká, približne 44% počas dňa a 45% v noci. Relatívna vlhkosť vzduchu sa bude pohybovať medzi 71% a 100% počas dňa a medzi 83% a 96% v noci.",
  		"location": "Horná Stubna, Slovensko"
  	}
  }
  ```

## 2. Get Historical Weather Articles Collection

- **Headers**:
  - `Accept-Language`: Choose `sk` for Slovak or `en` for English (English is the default if none is provided).
- **Query Parameters**:
  - `limit` (integer): Number of articles to fetch, between 1 and 10.
  - `offset` (integer): Starting point for fetching articles, must be 0 or higher.
  - `locationName` (string): Location name for which you want historical data.
  - `articleType` (string, optional): Either `"factual"` or `"bulvar"`; if not provided, both types are fetched.
  - `dateFrom` (timestamp, optional): Start date for filtering articles (in UNIX timestamp format).
  - `dateTo` (timestamp, optional): End date for filtering articles (in UNIX timestamp format).
- **Response Example**:
  ```json
  {
  	"message": [
  		{
  			"revId": 4,
  			"revType": "insert",
  			"createdAt": "2024-10-29T21:08:55.538Z",
  			"modifiedAt": "2024-10-29T21:08:55.538Z",
  			"revTimestamp": "2024-10-29T21:08:55.551Z",
  			"id": 4,
  			"locationKey": "297345",
  			"language": "en",
  			"articleType": "factual",
  			"title": "Bratislava's Weather: Showers Expected Late Tuesday Evening",
  			"perex": "Bratislava, Slovakia, is in for a partly sunny day on Tuesday, October 29th, with a chance of showers later in the evening.",
  			"description": "The temperature in Bratislava will range from a minimum of 9.9°C to a maximum of 20°C, with a real-feel temperature range of 9.5°C to 21.1°C. The day will offer 6.8 hours of sunshine. There's a 25% chance of rain, but no snow or ice is expected. During the day, winds will blow from the ESE at 5.6 km/h, and the sky will be partly sunny with 42% cloud cover. The relative humidity will average 76%. As night falls, the temperature will remain mild, with a minimum of 9.5°C and a real-feel temperature of 9.5°C. The night will bring a 49% chance of rain, with 0.2 mm of total liquid precipitation expected. Winds will shift to the NW at 3.7 km/h, and the sky will be partly cloudy with showers, featuring 46% cloud cover. Humidity levels will rise, with an average relative humidity of 93%."
  		}
  	]
  }
  ```

# Run Project and Tests

### Docker Version

```bash
docker compose up -d
```

### Local Development Version

1. Make sure PostgreSQL is running `docker compose up -d`.
2. Stop dockerized weather-api `docker stop weather-api`
3. Start the development server:

```bash
deno run dev
```

### Running Tests

```bash
deno run test all
```

This will execute all tests in the project.

# Application Structure

The project follows a pattern of using singleton instances for repositories, services, and clients. This ensures centralized control and efficient resource management across the application.

### `src/client`

Contains singleton instances for the LLM API client (for article generation) and the weather API client.

### `src/config`

Configuration files for the database, application settings, and rate limiting.

### `src/controller`

Defines the main API endpoints for the weather app. It includes:

- **Article Controllers**: Handles the endpoints for generating and retrieving weather articles.
- **Health Check Controller**: Provides a health check endpoint used in CI/CD to verify the application's status.

### `src/log`

Manages logging for the application, saving logs to both the console and filesystem with a simple retention policy:

- **Error Messages**: Stored in `src/log/error`
- **Info and Error Messages**: Stored in `src/log/app`
- **Debug Messages**: Stored in `src/log/debug`
- **Request Logs**: Stored in `src/log/message` (provides details about each request made to the app)

### `src/mapper/to_${some_name}.ts`

Contains functions that map objects of type `T` to specific `SomeName` types, used for transforming data between layers.

### `src/middleware`

This directory contains middleware functions intercept incomming requests by our defined functionality

- **Log Middleware**: Logs incoming requests.
- **Schema Validation Middleware**: Validates incoming requests against defined schemas.
- **Error Catcher Middleware**: Catches errors that occur during request processing and provides structured, localized error responses to users.

### `src/model`

Holds all models, entities, types, and enums used throughout the app. This includes:

- **DTOs**: Data transfer objects
- **Custom Errors**: Defines `WeatherServiceCommonError`, the main error type for the application.

### `src/schema`

Contains validation schemas for both incoming requests and responses from clients. Errors triggered here will be propagated as a throw of `WeatherServiceCommonError` with a relevant status and localized message.

### `src/repository/{abcd}_repository.ts`

Defines repository functions for CRUD operations on various entities (e.g. abcd), such as updating, deleting, and inserting records.

### `src/service`

Contains core business logic used by the controller layer, organized as singleton instances for efficiency.

### `src/util`

Contains utility files that don’t belong in specific directories or they are used widely across multiple layers of the application.

### `test/unit`

Contains unit tests for the application, ensuring core functionality is verified.

### `test/localization`

Contains tests to validate localization consistency, such as comparing English and Slovak localization files to ensure they are synchronized.

### `i18n`

Contains internal localization files for different languages, facilitating multilingual support.

### `database/`

- **DDL.sql**: Initializer file for the database with essential tables and configurations required by the app.
- **ERD.sql**: Represents the database schema, detailing the table structures ( triggers are not part of it, seems like a lack of pgAdmin tool).
- **weather.pgerd**: A file for import into pgAdmin, useful for further database design and updates. Changes made in pgAdmin can then be exported to update `DDL.sql` and synchronize with new `ERD.png`.

# Internal Features

Here’s a look at some internal features and mechanisms that enhance the functionality and reliability of the application.

- **Unique Article Identification**: Each article is uniquely identified by either a primary key or a composite key consisting of `language`, `location.Key`, and `articleType`. The `LLMArticle` table stores only the most recent version of each article. For instance, there will be only one latest factual Slovak article for Bratislava in the table at any time.

- **Article History with Triggers**: Triggers on the `LLMArticle` table create historical snapshots in the `LLMArticleAudit` table, recording every `insert` and `update` operation (deletes are not applicable). This table keeps a history of articles for each location.

- **Article Caching Mechanism**:
  - The app caches articles based on language, location, and article type, using an in-memory cache (Node Cache) with a duration of 180 minutes.
  - If a requested article is cached, it’s served much faster. If not, a new article is generated, cached, and upserted ( saved or updated) in the `LLMArticle` table.
  - After an article expires from the cache, a new request for the same article will regenerate it (updating the data) and update the `LLMArticle` table, (new state is also archived in `LLMArticleAudit`).

  **Example**:
  - User A requests a bulvar-style English article for New York; since it’s not cached, the LLM client generates it, then we cache it and save it to the database.
  - User B requests a factual-style article for the same location; a new article is generated and saved, as it’s a different style.
  - User C then requests the same factual article as User B, and it’s returned instantly from the cache.
  - After 180 minutes, if User D requests the same factual article, it’s regenerated and cached again (new saved also in `LLMArticleAudit`).

- **Single Response Delivery**: The app waits for the entire LLM client response before sending it to the user, rather than streaming it in parts.

- **Environment Variable Validation**: The application will exit with an error log if any required (from `APP_CONFIG`) environment variables are missing.

- **Rate Limiting**: A rate limiter is set with localized error responses in case of excessive usage.

- **Trial API Keys**: The app uses trial API keys, and if any key limit is exceeded for the day, a localized error message is returned to the user.

- **Security Measures**: The application uses Helmet and CORS for security.

- **Database Connection Flexibility**: The app is designed to run even if the database connection fails. This allows users to receive articles even if caching or database updates cannot be completed (the article will still be generated but won’t be saved).

- **HTTP Protocol**: The app runs over HTTP, as no sensitive data is handled.
